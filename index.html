<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>北九州輕旅行 V7.8 (除錯版)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f0fdfa; color: #334155; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .ios-btn:active { transform: scale(0.97); transition: transform 0.1s; }
        #map { height: 100%; width: 100%; z-index: 0; }
        .leaflet-pane { z-index: 0 !important; }
        .card-img-gradient { background: linear-gradient(to bottom, rgba(0,0,0,0) 60%, rgba(0,0,0,0.6) 100%); }
        .scroll-smooth { scroll-behavior: smooth; }
        
        /* 錯誤顯示區 (預設隱藏) */
        #debug-console {
            display: none;
            position: fixed; top: 0; left: 0; right: 0;
            background: #fee2e2; color: #b91c1c;
            padding: 20px; z-index: 99999;
            font-family: monospace; font-size: 12px;
            border-bottom: 2px solid #ef4444;
            max-height: 50vh; overflow: auto;
        }
    </style>
</head>
<body class="h-screen w-full overflow-hidden">

<div id="debug-console">
    <h3 class="font-bold text-lg mb-2">⚠️ 程式發生錯誤</h3>
    <p>請截圖此畫面傳給工程師：</p>
    <div id="error-msg" class="mt-2 whitespace-pre-wrap"></div>
    <button onclick="localStorage.clear(); location.reload()" class="mt-4 bg-red-500 text-white px-4 py-2 rounded shadow">清除快取並重整 (救命紐)</button>
</div>

<div id="app" class="h-full w-full max-w-md mx-auto bg-white shadow-2xl relative flex flex-col overflow-hidden">
    
    <header class="bg-white/95 backdrop-blur pt-12 pb-3 px-6 z-20 border-b border-gray-100 flex justify-between items-end">
        <div>
            <h1 class="text-2xl font-bold tracking-wider text-teal-700">福岡の旅</h1>
            <p class="text-gray-400 text-[10px] tracking-[0.2em] uppercase">V7.8 Debug</p>
        </div>
        <button @click="showSyncModal = true" class="bg-teal-50 text-teal-600 px-3 py-1.5 rounded-lg text-xs font-bold flex items-center shadow-sm border border-teal-100 hover:bg-teal-100 transition-colors">
            <i class="fa-solid fa-arrows-rotate mr-1"></i> 同步
        </button>
    </header>

    <main class="flex-1 overflow-y-auto no-scrollbar bg-gray-50 pb-24 relative">
        <div v-if="currentTab === 'schedule'" class="p-5">
            
            <div class="flex items-center space-x-2 mb-6 bg-white p-2 rounded-2xl shadow-sm border border-gray-100">
                <button @click="prevDay" :disabled="activeDay === 1" :class="['w-10 h-10 rounded-full flex items-center justify-center transition-colors flex-shrink-0', activeDay === 1 ? 'text-gray-200' : 'text-teal-600 bg-teal-50 hover:bg-teal-100 ios-btn']"><i class="fa-solid fa-chevron-left"></i></button>
                <div class="flex-1 overflow-x-auto no-scrollbar flex space-x-2 px-1 scroll-smooth" ref="dayContainer">
                    <button v-for="day in days" :key="day" :ref="(el) => setDayRef(el, day)" @click="activeDay = day" :class="['px-4 py-2 rounded-full text-sm font-bold whitespace-nowrap transition-all duration-300', activeDay === day ? 'bg-teal-500 text-white shadow-md scale-105' : 'text-gray-400 hover:bg-gray-50']">Day {{ day }}</button>
                </div>
                <button @click="nextDay" :disabled="activeDay === days.length" :class="['w-10 h-10 rounded-full flex items-center justify-center transition-colors flex-shrink-0', activeDay === days.length ? 'text-gray-200' : 'text-teal-600 bg-teal-50 hover:bg-teal-100 ios-btn']"><i class="fa-solid fa-chevron-right"></i></button>
                <button @click="deleteCurrentDay" class="w-10 h-10 rounded-full bg-red-50 text-red-500 flex items-center justify-center hover:bg-red-100 ios-btn border border-red-100 flex-shrink-0"><i class="fa-regular fa-trash-can"></i></button>
                <button @click="addNewDay" class="w-10 h-10 rounded-full bg-gray-100 text-gray-500 flex items-center justify-center hover:bg-gray-200 ios-btn border border-gray-200 flex-shrink-0"><i class="fa-solid fa-plus"></i></button>
            </div>
            
            <div class="space-y-6">
                <div v-if="filteredItinerary.length === 0" class="text-center py-20 text-gray-300 font-light">
                    <p class="text-lg font-bold mb-2">Day {{ activeDay }}</p>
                    <p class="text-xs">點擊右下角 + 新增行程</p>
                </div>
                
                <div v-for="(item, index) in filteredItinerary" :key="item.id" class="relative pl-6 border-l-[2px] border-teal-100 ml-3 group/card transition-all duration-300">
                    <div class="absolute -left-[9px] top-6 w-4 h-4 rounded-full bg-white border-[4px] border-teal-400 z-10"></div>
                    <div class="bg-white rounded-2xl shadow-md border border-gray-50 ios-btn relative overflow-hidden">
                        <div class="absolute right-0 top-0 bottom-0 w-10 bg-gray-50 border-l border-gray-100 flex flex-col justify-center items-center space-y-2 z-20">
                            <button v-if="index > 0" @click.stop="moveItem(item, -1)" class="w-8 h-8 flex items-center justify-center text-teal-400 hover:text-teal-600 hover:bg-teal-100 rounded-full transition-colors"><i class="fa-solid fa-chevron-up"></i></button>
                            <span class="text-[10px] text-gray-300 font-mono">{{ index + 1 }}</span>
                            <button v-if="index < filteredItinerary.length - 1" @click.stop="moveItem(item, 1)" class="w-8 h-8 flex items-center justify-center text-teal-400 hover:text-teal-600 hover:bg-teal-100 rounded-full transition-colors"><i class="fa-solid fa-chevron-down"></i></button>
                        </div>
                        <div class="pr-10">
                            <div v-if="item.img" class="h-32 w-full relative overflow-hidden group/img">
                                <img :src="item.img" class="w-full h-full object-cover" @error="item.img = null">
                                <div class="absolute inset-0 card-img-gradient"></div>
                                <div class="absolute top-2 right-2 flex space-x-2">
                                    <button @click.stop="deleteItem(item.id)" class="bg-black/40 text-white w-8 h-8 rounded-full flex items-center justify-center backdrop-blur-sm hover:bg-red-500 transition-colors"><i class="fa-solid fa-trash text-xs"></i></button>
                                </div>
                            </div>
                            <div class="p-4 pt-3 relative">
                                <div v-if="!item.img" class="flex justify-end absolute top-2 right-2">
                                    <button @click.stop="deleteItem(item.id)" class="text-gray-300 hover:text-red-400 p-2"><i class="fa-solid fa-trash"></i></button>
                                </div>
                                <div @click="editItem(item)" class="cursor-pointer">
                                    <div class="flex items-baseline space-x-2 mb-1">
                                        <span class="text-teal-600 font-black text-lg">{{ item.time }}</span>
                                        <h3 class="font-bold text-lg text-gray-800">{{ item.location }}</h3>
                                        <i class="fa-solid fa-pen text-[10px] text-gray-300 ml-1"></i>
                                    </div>
                                    <p v-if="item.desc" class="text-gray-600 text-sm leading-relaxed mb-2">{{ item.desc }}</p>
                                    <div v-if="item.note" class="bg-gray-50 p-2 rounded-lg text-xs text-gray-400 mb-2 flex items-start"><i class="fa-solid fa-circle-info mt-0.5 mr-1.5 text-teal-400"></i><span>{{ item.note }}</span></div>
                                </div>
                                <div class="flex items-center space-x-2 mt-2">
                                    <button v-if="item.lat" @click="showOnMap(item)" class="text-xs text-teal-600 bg-teal-50 px-2 py-1 rounded-lg font-bold flex items-center"><i class="fa-solid fa-map-location-dot mr-1"></i>地圖</button>
                                    <button v-else @click="manualLocate(item)" class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded-lg font-bold flex items-center hover:bg-teal-50 hover:text-teal-600 transition-colors"><span v-if="item.isLocating"><i class="fa-solid fa-spinner fa-spin mr-1"></i>搜尋</span><span v-else><i class="fa-solid fa-thumbtack mr-1"></i>定位</span></button>
                                    <a :href="'https://www.google.com/maps/search/?api=1&query=' + item.location" target="_blank" class="text-xs text-blue-400 bg-blue-50 px-2 py-1 rounded-lg font-bold flex items-center"><i class="fa-brands fa-google mr-1"></i>導航</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div v-if="currentTab === 'money'" class="p-5 pb-20">
            <div class="bg-teal-800 text-teal-50 p-5 rounded-2xl shadow-lg mb-6 flex justify-between items-center">
                <div><div class="text-xs opacity-70 mb-1">匯率 (JPY → TWD)</div><div class="text-2xl font-bold flex items-center"><span class="mr-2">×</span><input type="number" step="0.001" v-model="exchangeRate" class="bg-transparent border-b border-teal-400 w-20 text-center focus:outline-none font-mono"></div></div>
                <div class="text-right"><div class="text-xs opacity-70">1000円 ≈</div><div class="text-xl font-bold">NT$ {{ (1000 * exchangeRate).toFixed(0) }}</div></div>
            </div>
            <div class="space-y-3">
                 <div v-if="expenses.length === 0" class="text-center py-10 text-gray-300"><i class="fa-solid fa-receipt text-4xl mb-3 opacity-50"></i><p>尚無紀錄<br>點擊右下角 + 新增</p></div>
                <div v-for="(exp, idx) in expenses" :key="idx" class="bg-white p-4 rounded-xl flex justify-between items-center shadow-sm border border-gray-50">
                    <div><div class="font-bold text-gray-700">{{ exp.desc }}</div><div class="text-xs text-gray-400">{{ exp.payer }} 付款</div></div>
                    <div class="flex items-center"><div class="text-right mr-3"><div class="text-teal-600 font-bold">¥{{ exp.amount }}</div><div class="text-[10px] text-gray-400">≈ NT$ {{ Math.round(exp.amount * exchangeRate) }}</div></div>
                    <div class="flex space-x-1"><button @click="editExpense(idx)" class="w-8 h-8 rounded-full bg-gray-50 text-gray-400 hover:bg-teal-50 hover:text-teal-600 flex items-center justify-center transition-colors"><i class="fa-solid fa-pen text-xs"></i></button><button @click="deleteExpense(idx)" class="w-8 h-8 rounded-full bg-gray-50 text-gray-400 hover:bg-red-50 hover:text-red-400 flex items-center justify-center transition-colors"><i class="fa-solid fa-trash text-xs"></i></button></div></div>
                </div>
            </div>
            <div v-if="settlement.length > 0" class="mt-8 bg-white p-5 rounded-2xl border border-gray-100"><h3 class="font-bold text-teal-800 mb-4 text-sm">結算建議 (台幣)</h3><ul class="space-y-2"><li v-for="s in settlement" class="flex justify-between text-sm text-gray-600 border-b border-gray-50 pb-2"><span>{{ s.from }} <i class="fa-solid fa-arrow-right text-xs mx-1"></i> {{ s.to }}</span><span class="font-bold text-teal-600">NT$ {{ Math.round(s.amount * exchangeRate) }}</span></li></ul></div>
        </div>
        <div v-show="currentTab === 'map'" class="absolute inset-0 bg-gray-200 z-0"><div id="map"></div><div class="absolute bottom-24 right-4 flex flex-col space-y-3 z-[400]"><button @click="locateMe" class="w-12 h-12 bg-white rounded-full shadow-lg text-blue-500 flex items-center justify-center text-xl ios-btn"><i class="fa-solid fa-location-crosshairs"></i></button><button @click="fitAllMarkers" class="w-12 h-12 bg-white rounded-full shadow-lg text-teal-600 flex items-center justify-center text-xl ios-btn"><i class="fa-solid fa-expand"></i></button></div></div>
    </main>

    <nav class="bg-white/95 backdrop-blur border-t border-gray-100 flex justify-around items-center h-[85px] pb-6 fixed bottom-0 w-full max-w-md z-30">
        <button @click="switchTab('schedule')" :class="['flex flex-col items-center w-full space-y-1', currentTab === 'schedule' ? 'text-teal-600' : 'text-gray-300']"><i class="fa-solid fa-calendar-check text-xl"></i><span class="text-[10px]">行程</span></button>
        <button @click="switchTab('money')" :class="['flex flex-col items-center w-full space-y-1', currentTab === 'money' ? 'text-teal-600' : 'text-gray-300']"><i class="fa-solid fa-sack-dollar text-xl"></i><span class="text-[10px]">分帳</span></button>
        <button @click="switchTab('map')" :class="['flex flex-col items-center w-full space-y-1', currentTab === 'map' ? 'text-teal-600' : 'text-gray-300']"><i class="fa-solid fa-map text-xl"></i><span class="text-[10px]">地圖</span></button>
    </nav>

    <div v-if="showAddModal" class="fixed inset-0 bg-black/40 z-50 flex items-end justify-center p-4"><div class="bg-white w-full rounded-3xl p-6 shadow-2xl mb-4 animate-slide-up max-h-[90vh] overflow-y-auto"><h3 class="font-bold text-gray-800 mb-4 text-center">{{ isEditing ? '編輯行程' : '新增行程' }}</h3><div class="space-y-4"><input type="time" v-model="form.time" class="w-full bg-gray-50 p-3 rounded-xl text-center font-bold text-teal-700 outline-none"><input type="text" v-model="form.location" placeholder="地點名稱" class="w-full bg-gray-50 p-3 rounded-xl outline-none text-center font-bold"><div><input type="text" v-model="form.img" placeholder="圖片連結 (貼上網址)" class="w-full bg-gray-50 p-3 rounded-xl outline-none text-xs text-gray-500 mb-2"><div v-if="form.img" class="w-full h-32 rounded-xl overflow-hidden bg-gray-100"><img :src="form.img" class="w-full h-full object-cover" alt="預覽" @error="form.img = ''"></div></div><textarea v-model="form.desc" placeholder="景點介紹..." class="w-full bg-gray-50 p-3 rounded-xl outline-none h-24 resize-none text-sm"></textarea><input type="text" v-model="form.note" placeholder="備註提醒" class="w-full bg-gray-50 p-3 rounded-xl outline-none text-xs"><div class="flex space-x-3 pt-2"><button @click="closeModal" class="flex-1 py-3 bg-gray-100 rounded-xl text-gray-500 font-bold">取消</button><button @click="saveItemInstant" class="flex-1 py-3 bg-teal-500 text-white rounded-xl font-bold">{{ isEditing ? '更新' : '儲存' }}</button></div></div></div></div>
    <div v-if="showExpenseModal" class="fixed inset-0 bg-black/40 z-50 flex items-end justify-center p-4"><div class="bg-white w-full rounded-3xl p-6 shadow-2xl mb-4 animate-slide-up"><h3 class="font-bold text-gray-800 mb-4 text-center">{{ isEditingExpense ? '修改帳務' : '新增帳務' }}</h3><div class="space-y-4"><div class="grid grid-cols-2 gap-3"><input v-model="newExpense.payer" placeholder="付款人" class="bg-gray-50 p-3 rounded-xl text-center font-bold outline-none focus:ring-2 ring-teal-200"><input type="number" v-model.number="newExpense.amount" placeholder="金額 (日幣)" class="bg-gray-50 p-3 rounded-xl text-center font-bold outline-none focus:ring-2 ring-teal-200"></div><input v-model="newExpense.desc" placeholder="消費項目 (例如: 拉麵)" class="w-full bg-gray-50 p-3 rounded-xl text-center outline-none focus:ring-2 ring-teal-200"><div class="flex space-x-3 pt-2"><button @click="closeExpenseModal" class="flex-1 py-3 bg-gray-100 rounded-xl text-gray-500 font-bold">取消</button><button @click="saveExpense" class="flex-1 py-3 bg-teal-500 text-white rounded-xl font-bold">{{ isEditingExpense ? '確認修改' : '記上一筆' }}</button></div></div></div></div>
    <div v-if="showSyncModal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4"><div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl"><h3 class="text-xl font-bold text-teal-800 mb-2 text-center">行程資料同步</h3><div class="space-y-6"><div class="bg-teal-50 p-4 rounded-xl border border-teal-100"><h4 class="font-bold text-teal-700 text-sm mb-2">匯出</h4><textarea readonly class="w-full bg-white h-20 text-[10px] p-2 rounded-lg border border-teal-200 text-gray-500 font-mono resize-none mb-2" id="exportArea">{{ exportString }}</textarea><button @click="copyCode" class="w-full bg-teal-500 text-white py-2 rounded-lg text-sm font-bold ios-btn"><span v-if="copySuccess"><i class="fa-solid fa-check"></i> 已複製</span><span v-else>複製代碼</span></button></div><div class="bg-gray-50 p-4 rounded-xl border border-gray-200"><h4 class="font-bold text-gray-700 text-sm mb-2">匯入</h4><input v-model="importString" placeholder="貼上代碼..." class="w-full bg-white p-3 rounded-lg border border-gray-300 text-xs mb-2 outline-none"><button @click="importData" class="w-full bg-gray-700 text-white py-2 rounded-lg text-sm font-bold ios-btn">讀取覆蓋</button></div></div><div class="mt-6 flex justify-between items-center border-t border-gray-100 pt-4"><button @click="resetData" class="text-xs text-red-300 hover:text-red-500 px-2">重置</button><button @click="showSyncModal = false" class="px-6 py-2 bg-gray-100 rounded-xl text-gray-600 font-bold text-sm">關閉</button></div></div></div>

    <button v-if="currentTab === 'schedule' || currentTab === 'money'" @click="handleFabClick" class="fixed bottom-24 right-6 w-14 h-14 bg-teal-500 text-white rounded-full shadow-lg shadow-teal-500/40 flex items-center justify-center text-xl ios-btn z-20 transition-all hover:scale-105"><i class="fa-solid fa-plus"></i></button>

</div>

<script>
    // 1. 全局錯誤攔截 (如果程式死掉，會顯示紅字)
    window.onerror = function(msg, source, lineno, colno, error) {
        document.getElementById('debug-console').style.display = 'block';
        document.getElementById('error-msg').innerText = `${msg}\nLine: ${lineno}`;
        return false;
    };

    const { createApp, nextTick } = Vue;
    
    const app = createApp({
        data() {
            return {
                currentTab: 'schedule', activeDay: 1, days: [1, 2, 3],
                dayRefs: {},
                showAddModal: false, showSyncModal: false, showExpenseModal: false,
                importString: '', copySuccess: false, exchangeRate: 0.22, map: null, markers: [], userMarker: null,
                isEditing: false, isEditingExpense: false, editingExpenseIndex: null,
                itinerary: JSON.parse(localStorage.getItem('trip_itinerary_v7')) || [{ id: 1, day: 1, time: '11:00', location: '福岡機場', desc: '抵達福岡，記得先去櫃檯領取預約好的 JR Pass。', note: '出關約需 40 分鐘', img: 'https://images.unsplash.com/photo-1579202673506-ca3ce28943ef?auto=format&fit=crop&q=80&w=800', lat: null, lng: null, isLocating: false }],
                form: { id: null, time: '', location: '', note: '', desc: '', img: '' },
                expenses: JSON.parse(localStorage.getItem('trip_expenses_v7')) || [],
                newExpense: { payer: '', amount: '', desc: '' }
            }
        },
        mounted() {
            const savedRate = localStorage.getItem('trip_rate');
            if(savedRate) this.exchangeRate = parseFloat(savedRate);
        },
        watch: { 
            exchangeRate(newVal) { localStorage.setItem('trip_rate', newVal); },
            activeDay(newVal) { this.scrollToActiveDay(); }
        },
        computed: {
            filteredItinerary() { return this.itinerary.filter(i => i.day === this.activeDay); },
            exportString() { const data = { i: this.itinerary, e: this.expenses, r: this.exchangeRate }; try { return btoa(unescape(encodeURIComponent(JSON.stringify(data)))); } catch(e) { return "Error"; } },
            settlement() { 
                // 分帳邏輯 (防止無限迴圈保護)
                let payers = {}; let total = 0; 
                this.expenses.forEach(e => { if (!payers[e.payer]) payers[e.payer] = 0; payers[e.payer] += e.amount; total += e.amount; }); 
                let people = Object.keys(payers); 
                if (people.length === 0) return []; 
                let avg = total / people.length; 
                let balance = people.map(p => ({ name: p, diff: payers[p] - avg })); 
                let creditors = balance.filter(b => b.diff > 0).sort((a,b) => b.diff - a.diff); 
                let debtors = balance.filter(b => b.diff < 0).sort((a,b) => a.diff - b.diff); 
                let res = []; let i = 0, j = 0; 
                let safeGuard = 0; // 安全計數器
                while(i < creditors.length && j < debtors.length && safeGuard < 100){ 
                    safeGuard++;
                    let min = Math.min(creditors[i].diff, Math.abs(debtors[j].diff)); 
                    if(min > 10) res.push({ from: debtors[j].name, to: creditors[i].name, amount: Math.round(min) }); 
                    creditors[i].diff -= min; debtors[j].diff += min; 
                    if(creditors[i].diff < 1) i++; if(Math.abs(debtors[j].diff) < 1) j++; 
                } 
                return res; 
            }
        },
        methods: {
            setDayRef(el, day) { if (el) this.dayRefs[day] = el; },
            scrollToActiveDay() { nextTick(() => { const el = this.dayRefs[this.activeDay]; if (el) el.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' }); }); },
            prevDay() { if (this.activeDay > 1) this.activeDay--; },
            nextDay() { if (this.activeDay < this.days.length) this.activeDay++; },
            addNewDay() { this.days.push(this.days.length + 1); this.activeDay = this.days.length; },
            
            deleteCurrentDay() {
                if(this.days.length <= 1) return alert("至少要保留一天！");
                if(!confirm(`確定要刪除 Day ${this.activeDay} 嗎？\n\n這天的所有行程也會被刪除！\n後面的天數會自動往前遞補。`)) return;
                this.itinerary = this.itinerary.filter(i => i.day !== this.activeDay);
                this.itinerary.forEach(i => { if (i.day > this.activeDay) i.day--; });
                this.days.pop();
                if (this.activeDay > this.days.length) this.activeDay = this.days.length;
                this.saveData();
            },

            moveItem(item, direction) { const dayItems = this.itinerary.filter(i => i.day === this.activeDay); const currentIdx = dayItems.findIndex(i => i.id === item.id); if (currentIdx === -1) return; if (direction === -1 && currentIdx === 0) return; if (direction === 1 && currentIdx === dayItems.length - 1) return; const neighbor = dayItems[currentIdx + direction]; const realIdx1 = this.itinerary.findIndex(i => i.id === item.id); const realIdx2 = this.itinerary.findIndex(i => i.id === neighbor.id); [this.itinerary[realIdx1], this.itinerary[realIdx2]] = [this.itinerary[realIdx2], this.itinerary[realIdx1]]; this.saveData(); },
            handleFabClick() { if (this.currentTab === 'schedule') { this.openAddModal(); } else if (this.currentTab === 'money') { this.openExpenseModal(); } },
            openAddModal() { this.isEditing = false; this.form = { id: null, time: '', location: '', note: '', desc: '', img: '' }; this.showAddModal = true; },
            editItem(item) { this.form = { ...item }; this.isEditing = true; this.showAddModal = true; },
            closeModal() { this.showAddModal = false; this.isEditing = false; this.form = { id: null, time: '', location: '', note: '', desc: '', img: '' }; },
            saveItemInstant() { if (!this.form.time || !this.form.location) return alert('請輸入時間與地點'); if (this.isEditing) { const index = this.itinerary.findIndex(i => i.id === this.form.id); if (index !== -1) this.itinerary[index] = { ...this.form, day: this.activeDay }; } else { this.itinerary.push({ id: Date.now(), day: this.activeDay, time: this.form.time, location: this.form.location, note: this.form.note, desc: this.form.desc, img: this.form.img, lat: null, lng: null, isLocating: false }); } this.saveData(); this.closeModal(); },
            openExpenseModal() { this.isEditingExpense = false; this.newExpense = { payer: '', amount: '', desc: '' }; this.showExpenseModal = true; },
            editExpense(idx) { this.newExpense = { ...this.expenses[idx] }; this.editingExpenseIndex = idx; this.isEditingExpense = true; this.showExpenseModal = true; },
            closeExpenseModal() { this.showExpenseModal = false; this.isEditingExpense = false; this.newExpense = { payer: '', amount: '', desc: '' }; },
            saveExpense() { if(!this.newExpense.payer || !this.newExpense.amount) return alert("請輸入付款人與金額"); if (this.isEditingExpense && this.editingExpenseIndex !== null) { this.expenses[this.editingExpenseIndex] = { ...this.newExpense }; } else { this.expenses.unshift({...this.newExpense}); } this.saveData(); this.closeExpenseModal(); },
            deleteExpense(idx) { if(confirm('刪除這筆帳目？')) { this.expenses.splice(idx, 1); this.saveData(); } },
            copyCode() { const el = document.getElementById('exportArea'); el.select(); document.execCommand('copy'); this.copySuccess = true; setTimeout(() => this.copySuccess = false, 2000); },
            importData() { if(!this.importString) return alert("請貼上代碼"); if(!confirm("覆蓋原本資料？")) return; try { const json = decodeURIComponent(escape(atob(this.importString.trim()))); const data = JSON.parse(json); if(data.i) this.itinerary = data.i; if(data.e) this.expenses = data.e; if(data.r) this.exchangeRate = data.r; this.saveData(); alert("同步成功"); this.showSyncModal = false; this.importString = ''; location.reload(); } catch(e) { alert("代碼錯誤"); } },
            resetData() { if(confirm('清空重來？')) { localStorage.removeItem('trip_itinerary_v7'); localStorage.removeItem('trip_expenses_v7'); location.reload(); } },
            switchTab(tab) { this.currentTab = tab; if (tab === 'map') nextTick(() => this.initMap()); },
            changeDay(day) { this.activeDay = day; if (this.currentTab === 'map') this.updateMapMarkers(); },
            initMap() { if (this.map) { this.map.invalidateSize(); this.updateMapMarkers(); return; } this.map = L.map('map').setView([33.5902, 130.4017], 13); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap' }).addTo(this.map); this.updateMapMarkers(); },
            updateMapMarkers() { if (!this.map) return; this.markers.forEach(m => this.map.removeLayer(m)); this.markers = []; const points = []; this.filteredItinerary.forEach(item => { if (item.lat && item.lng) { const marker = L.marker([item.lat, item.lng]).addTo(this.map).bindPopup(`<b>${item.time}</b><br>${item.location}`); this.markers.push(marker); points.push([item.lat, item.lng]); } }); if (points.length > 0) this.map.fitBounds(L.latLngBounds(points), { padding: [50, 50] }); },
            showOnMap(item) { this.switchTab('map'); nextTick(() => { this.map.setView([item.lat, item.lng], 16); L.popup().setLatLng([item.lat, item.lng]).setContent(item.location).openOn(this.map); }); },
            locateMe() { if (!navigator.geolocation) return alert("不支援定位"); navigator.geolocation.getCurrentPosition(pos => { const { latitude, longitude } = pos.coords; if (this.userMarker) this.map.removeLayer(this.userMarker); this.userMarker = L.circleMarker([latitude, longitude], { radius: 8, fillColor: "#3b82f6", color: "#fff", weight: 2, opacity: 1, fillOpacity: 0.8 }).addTo(this.map).bindPopup("我在這").openPopup(); this.map.setView([latitude, longitude], 15); }, () => alert("無法取得位置")); },
            fitAllMarkers() { this.updateMapMarkers(); },
            async manualLocate(item) { item.isLocating = true; try { const q = encodeURIComponent(item.location + " Fukuoka"); const controller = new AbortController(); setTimeout(() => controller.abort(), 3000); const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${q}`, { signal: controller.signal }); const data = await res.json(); if (data && data.length > 0) { item.lat = parseFloat(data[0].lat); item.lng = parseFloat(data[0].lon); this.saveData(); } else { alert('找不到地點'); } } catch (e) { alert('連線失敗'); } finally { item.isLocating = false; } },
            saveData() { localStorage.setItem('trip_itinerary_v7', JSON.stringify(this.itinerary)); localStorage.setItem('trip_expenses_v7', JSON.stringify(this.expenses)); },
            addExpense() { this.saveExpense(); },
            deleteItem(id) { if(confirm('刪除？')) { this.itinerary = this.itinerary.filter(i => i.id !== id); this.saveData(); } }
        }
    });
    
    app.mount('#app');
</script>

</body>
</html>
