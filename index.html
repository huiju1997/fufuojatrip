<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>北九州輕旅行</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        /* 設定全域字體與背景 */
        body {
            font-family: 'Noto Sans JP', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f8fafc; /* 極淺灰背景 */
            color: #334155; /* 深灰文字，比純黑更柔和 */
        }
        /* 隱藏捲軸 */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* iOS 風格按鈕回饋 */
        .ios-btn:active { transform: scale(0.97); transition: transform 0.1s ease-in-out; }
        
        /* 自定義湖水綠色碼 (Tailwind 配置) */
        <script>
            tailwind.config = {
                theme: {
                    extend: {
                        colors: {
                            teal: {
                                50: '#f0fdfa', 100: '#ccfbf1', 200: '#99f6e4', 300: '#5eead4',
                                400: '#2dd4bf', 500: '#14b8a6', 600: '#0d9488', 700: '#0f766e',
                                800: '#115e59', 900: '#134e4a',
                            }
                        }
                    }
                }
            }
        </script>
    </style>
</head>
<body class="h-screen w-full overflow-hidden">

<div id="app" class="h-full w-full max-w-md mx-auto bg-white shadow-xl relative flex flex-col overflow-hidden font-sans">
    
    <header class="bg-white pt-12 pb-4 px-6 z-10 border-b border-gray-50">
        <h1 class="text-2xl font-bold tracking-wider text-teal-700">
            福岡北九州の旅
        </h1>
        <p class="text-gray-400 text-xs mt-2 tracking-widest uppercase">Minimalist Travel Planner</p>
    </header>

    <main class="flex-1 overflow-y-auto no-scrollbar bg-gray-50 pb-24 relative">
        
        <div v-if="currentTab === 'schedule'" class="p-5">
            <div class="flex space-x-3 overflow-x-auto no-scrollbar mb-8 py-2 pl-1">
                <button 
                    v-for="day in days" 
                    :key="day"
                    @click="activeDay = day"
                    :class="['px-6 py-2.5 rounded-full whitespace-nowrap text-sm font-medium transition-all shadow-sm', 
                             activeDay === day ? 'bg-teal-500 text-white shadow-teal-200/50' : 'bg-white text-gray-400 border border-gray-100']">
                    Day {{ day }}
                </button>
                <button @click="addDay" class="px-4 py-2.5 rounded-full bg-gray-100 text-gray-400 border border-gray-100 ios-btn">
                    <i class="fa-solid fa-plus"></i>
                </button>
            </div>

            <div class="space-y-6">
                <div v-if="filteredItinerary.length === 0" class="text-center py-16 text-gray-300">
                    <i class="fa-regular fa-map text-5xl mb-4 opacity-50"></i>
                    <p class="font-light tracking-wider">本日尚無行程</p>
                </div>

                <div v-for="(item, index) in filteredItinerary" :key="item.id" class="relative pl-8 border-l-[1.5px] border-teal-100 ml-2">
                    <div class="absolute -left-[7px] top-5 w-[14px] h-[14px] rounded-full bg-teal-500 border-[3px] border-white shadow-sm"></div>
                    
                    <div class="bg-white p-5 rounded-2xl shadow-[0_2px_15px_-3px_rgba(0,0,0,0.07),0_10px_20px_-2px_rgba(0,0,0,0.04)] ios-btn relative group border border-gray-50">
                        <div class="flex justify-between items-start mb-3">
                            <div class="flex flex-col">
                                <span class="text-teal-600 font-bold text-lg leading-none">{{ item.time }}</span>
                                <div v-if="weather" class="flex items-center mt-2 text-xs text-gray-400 bg-teal-50/50 px-2 py-1 rounded-md w-max">
                                    <i :class="[weatherIcon, 'mr-1 text-teal-400']"></i>
                                    <span>{{ weather.temperature }}°C (福岡現況)</span>
                                </div>
                            </div>
                            <div class="flex space-x-1">
                                <button @click="editItem(item)" class="text-gray-300 p-2 hover:text-teal-500 transition-colors">
                                    <i class="fa-solid fa-pen-to-square"></i>
                                </button>
                                <button @click="deleteItem(item.id)" class="text-gray-300 p-2 hover:text-red-400 transition-colors">
                                    <i class="fa-regular fa-trash-can"></i>
                                </button>
                            </div>
                        </div>
                        
                        <h3 class="font-bold text-xl text-gray-800 mb-1">{{ item.location }}</h3>
                        <p class="text-gray-500 text-sm font-light leading-relaxed">{{ item.note }}</p>

                        <button @click="openMap(item.location)" class="mt-4 w-full py-2.5 bg-teal-50 text-teal-600 rounded-xl text-sm font-medium flex items-center justify-center hover:bg-teal-100 transition-colors">
                            <i class="fa-solid fa-location-dot mr-2"></i> 導航前往
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="currentTab === 'money'" class="p-5">
            <div class="bg-white p-6 rounded-3xl shadow-[0_4px_20px_-4px_rgba(0,0,0,0.1)] mb-8 border border-gray-50">
                <h2 class="font-bold text-gray-700 mb-5 text-center tracking-widest">新增消費</h2>
                <div class="space-y-4">
                    <div class="flex space-x-3">
                         <input v-model="newExpense.payer" placeholder="付款人" class="flex-1 bg-gray-50 p-4 rounded-2xl text-sm border-none focus:ring-2 ring-teal-100 outline-none text-center">
                         <input v-model.number="newExpense.amount" type="number" placeholder="金額 (¥)" class="flex-1 bg-gray-50 p-4 rounded-2xl text-sm border-none focus:ring-2 ring-teal-100 outline-none text-center font-medium">
                    </div>
                    <input v-model="newExpense.desc" placeholder="消費項目說明" class="w-full bg-gray-50 p-4 rounded-2xl text-sm border-none focus:ring-2 ring-teal-100 outline-none text-center">
                    <button @click="addExpense" class="w-full bg-teal-500 hover:bg-teal-600 text-white py-4 rounded-2xl font-bold shadow-teal-200/30 shadow-lg ios-btn tracking-wider transition-colors">
                        記上一筆
                    </button>
                </div>
            </div>

            <div class="bg-white p-6 rounded-3xl border border-teal-50 mb-8 shadow-sm">
                <h3 class="font-bold text-teal-800 mb-4 flex items-center tracking-wider">
                    <i class="fa-solid fa-scale-balanced mr-2 opacity-70"></i>分帳建議
                </h3>
                <div v-if="settlement.length === 0" class="text-sm text-gray-400 font-light py-2">目前無須結算。</div>
                <ul class="space-y-3">
                    <li v-for="s in settlement" class="flex justify-between items-center p-3 bg-teal-50/30 rounded-xl">
                        <div class="flex items-center space-x-2 text-sm">
                            <span class="font-medium text-gray-600">{{ s.from }}</span>
                            <i class="fa-solid fa-caret-right text-teal-300"></i>
                            <span class="font-medium text-gray-600">{{ s.to }}</span>
                        </div>
                        <span class="text-teal-600 font-bold">¥{{ s.amount.toLocaleString() }}</span>
                    </li>
                </ul>
            </div>

            <h3 class="font-bold text-gray-500 mb-4 px-2 text-sm tracking-wider">消費紀錄明細</h3>
            <div class="space-y-3 mb-10">
                <div v-for="(exp, idx) in expenses" :key="idx" class="bg-white px-5 py-4 rounded-2xl flex justify-between items-center shadow-sm border border-gray-50">
                    <div>
                        <div class="font-medium text-gray-800">{{ exp.desc }}</div>
                        <div class="text-xs text-gray-400 mt-1 font-light">{{ exp.payer }} 先付</div>
                    </div>
                    <div class="flex items-center">
                        <span class="text-teal-600 font-bold mr-4">¥{{ exp.amount.toLocaleString() }}</span>
                        <button @click="deleteExpense(idx)" class="text-gray-200 hover:text-red-300 transition-colors"><i class="fa-solid fa-xmark"></i></button>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="currentTab === 'map'" class="h-full w-full flex flex-col bg-white">
            <div class="p-5 z-10">
                <div class="relative">
                     <input v-model="mapSearch" @keyup.enter="updateMap" placeholder="搜尋地點..." class="w-full bg-gray-100 p-4 rounded-2xl pl-12 outline-none focus:ring-2 ring-teal-100 text-sm font-medium">
                     <i class="fa-solid fa-magnifying-glass absolute left-5 top-[18px] text-gray-400"></i>
                </div>
            </div>
            <div class="flex-1 relative rounded-t-3xl overflow-hidden">
                <iframe width="100%" height="100%" frameborder="0" style="border:0" :src="mapUrl" allowfullscreen class="grayscale-[20%] contrast-[1.1]"></iframe>
            </div>
        </div>
    </main>

    <nav class="bg-white/90 backdrop-blur-md border-t border-gray-50 flex justify-around items-center h-[88px] pb-6 fixed bottom-0 w-full max-w-md z-30 shadow-[0_-4px_10px_rgba(0,0,0,0.03)]">
        <button @click="currentTab = 'schedule'" :class="['flex flex-col items-center justify-center w-full h-full space-y-1.5 group', currentTab === 'schedule' ? 'text-teal-600' : 'text-gray-300']">
            <i class="fa-solid fa-calendar-day text-xl transition-transform group-active:scale-90"></i>
            <span class="text-[10px] font-medium tracking-widest">行程</span>
        </button>
        <button @click="currentTab = 'money'" :class="['flex flex-col items-center justify-center w-full h-full space-y-1.5 group', currentTab === 'money' ? 'text-teal-600' : 'text-gray-300']">
            <i class="fa-solid fa-coins text-xl transition-transform group-active:scale-90"></i>
            <span class="text-[10px] font-medium tracking-widest">分帳</span>
        </button>
        <button @click="currentTab = 'map'" :class="['flex flex-col items-center justify-center w-full h-full space-y-1.5 group', currentTab === 'map' ? 'text-teal-600' : 'text-gray-300']">
            <i class="fa-solid fa-map text-xl transition-transform group-active:scale-90"></i>
            <span class="text-[10px] font-medium tracking-widest">地圖</span>
        </button>
    </nav>

    <div v-if="currentTab === 'schedule'" class="fixed bottom-[100px] right-6 z-20">
        <button @click="showAddModal = true" class="w-14 h-14 bg-teal-500 text-white rounded-full shadow-lg shadow-teal-500/30 flex items-center justify-center text-xl ios-btn transition-transform hover:scale-105 hover:bg-teal-600">
            <i class="fa-solid fa-plus"></i>
        </button>
    </div>

    <transition name="fade">
        <div v-if="showAddModal" class="fixed inset-0 bg-gray-900/40 backdrop-blur-sm z-50 flex items-end justify-center sm:items-center p-4 transition-opacity">
            <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl relative transition-transform transform translate-y-0 sm:rounded-3xl">
                <h3 class="text-lg font-bold mb-6 text-center text-gray-700 tracking-wider">{{ isEditing ? '編輯行程' : '新增行程' }}</h3>
                <div class="space-y-5">
                    <div>
                        <label class="text-xs text-teal-600 font-bold ml-2 mb-1 block tracking-wider">TIME</label>
                        <input type="time" v-model="form.time" class="w-full bg-gray-50 p-4 rounded-2xl border-none focus:ring-2 ring-teal-100 outline-none text-center font-bold text-gray-600">
                    </div>
                    <div>
                        <label class="text-xs text-teal-600 font-bold ml-2 mb-1 block tracking-wider">LOCATION</label>
                        <input type="text" v-model="form.location" placeholder="地點名稱" class="w-full bg-gray-50 p-4 rounded-2xl border-none focus:ring-2 ring-teal-100 outline-none text-sm">
                    </div>
                    <div>
                        <label class="text-xs text-gray-400 font-bold ml-2 mb-1 block tracking-wider">NOTE</label>
                        <textarea v-model="form.note" placeholder="備註事項..." class="w-full bg-gray-50 p-4 rounded-2xl border-none focus:ring-2 ring-teal-100 outline-none h-24 text-sm resize-none"></textarea>
                    </div>
                </div>
                <div class="flex space-x-3 mt-8">
                    <button @click="closeModal" class="flex-1 py-3.5 bg-gray-100 rounded-2xl text-gray-500 font-medium text-sm tracking-wider ios-btn">取消</button>
                    <button @click="saveItem" class="flex-1 py-3.5 bg-teal-500 text-white rounded-2xl font-bold shadow-lg shadow-teal-200/30 text-sm tracking-wider ios-btn hover:bg-teal-600 transition-colors">儲存</button>
                </div>
            </div>
        </div>
    </transition>

</div>

<script>
    const { createApp } = Vue;

    createApp({
        data() {
            return {
                currentTab: 'schedule',
                activeDay: 1,
                days: [1, 2, 3],
                showAddModal: false,
                isEditing: false,
                mapSearch: '福岡博多車站',
                // 天氣資料
                weather: null,
                
                // 行程資料 (預設範例)
                itinerary: JSON.parse(localStorage.getItem('trip_itinerary_v2')) || [
                    { id: 1, day: 1, time: '11:00', location: '福岡機場', note: '抵達、購買地鐵一日券' },
                    { id: 2, day: 1, time: '13:00', location: '博多一雙拉麵', note: '著名的泡沫系豚骨拉麵，可能要排隊' },
                    { id: 3, day: 1, time: '15:30', location: '大濠公園', note: '在湖邊散步、喝星巴克' },
                    { id: 4, day: 2, time: '09:30', location: '太宰府天滿宮', note: '吃梅枝餅、參拜求學問' },
                ],
                form: { id: null, time: '', location: '', note: '' },
                expenses: JSON.parse(localStorage.getItem('trip_expenses_v2')) || [],
                newExpense: { payer: '', amount: '', desc: '' },
            }
        },
        mounted() {
            this.fetchWeather();
        },
        computed: {
            filteredItinerary() {
                return this.itinerary
                    .filter(item => item.day === this.activeDay)
                    .sort((a, b) => a.time.localeCompare(b.time));
            },
            mapUrl() {
                // 使用較新的 Google Maps Embed API 格式
                return https://www.google.com/maps/embed/v1/place?key=&q=${encodeURIComponent(this.mapSearch)}&zoom=15&language=zh-TW;
                // 注意：若上述連結失效 (因無 API Key)，請暫時換回舊版：
                // return https://maps.google.com/maps?q=${encodeURIComponent(this.mapSearch)}&t=&z=15&ie=UTF8&iwloc=&output=embed;
            },
            weatherIcon() {
                if (!this.weather) return 'fa-solid fa-spinner fa-spin';
                const code = this.weather.weathercode;
                // 簡單的 WMO 天氣代碼對應
                if (code === 0) return 'fa-solid fa-sun'; // 晴天
                if (code >= 1 && code <= 3) return 'fa-solid fa-cloud-sun'; // 多雲
                if (code >= 45 && code <= 48) return 'fa-solid fa-smog'; // 霧
                if (code >= 51 && code <= 67) return 'fa-solid fa-cloud-rain'; // 雨
                if (code >= 71 && code <= 77) return 'fa-regular fa-snowflake'; // 雪
                if (code >= 95) return 'fa-solid fa-bolt'; // 雷雨
                return 'fa-solid fa-cloud'; // 預設
            },
            settlement() {
                if (this.expenses.length === 0) return [];
                let payers = {};
                let total = 0;
                this.expenses.forEach(e => {
                    if (!payers[e.payer]) payers[e.payer] = 0;
                    payers[e.payer] += e.amount;
                    total += e.amount;
                });
                let people = Object.keys(payers);
                if (people.length === 0) return [];
                let average = total / people.length;
                let balance = people.map(p => ({ name: p, diff: payers[p] - average }));
                let creditors = balance.filter(b => b.diff > 1).sort((a, b) => b.diff - a.diff);
                let debtors = balance.filter(b => b.diff < -1).sort((a, b) => a.diff - b.diff);
                let result = [];
                let cIdx = 0; let dIdx = 0;
                while (cIdx < creditors.length && dIdx < debtors.length) {
                    let credit = creditors[cIdx].diff;
                    let debt = Math.abs(debtors[dIdx].diff);
                    let amount = Math.min(credit, debt);
                    if (amount > 1) {
                        result.push({ from: debtors[dIdx].name, to: creditors[cIdx].name, amount: Math.round(amount) });
                    }
                    creditors[cIdx].diff -= amount; debtors[dIdx].diff += amount;
                    if (creditors[cIdx].diff < 1) cIdx++; if (Math.abs(debtors[dIdx].diff) < 1) dIdx++;
                }
                return result;
            }
        },
        methods: {
            // 抓取天氣數據 (使用 Open-Meteo 免費 API，設定為福岡座標)
            fetchWeather() {
                const fukuokaLat = 33.5902;
                const fukuokaLon = 130.4017;
                fetch(https://api.open-meteo.com/v1/forecast?latitude=${fukuokaLat}&longitude=${fukuokaLon}&current_weather=true)
                    .then(response => response.json())
                    .then(data => {
                        if (data.current_weather) {
                            this.weather = data.current_weather;
                        }
                    })
                    .catch(err => console.error("天氣資料抓取失敗:", err));
            },
            saveData() {
                localStorage.setItem('trip_itinerary_v2', JSON.stringify(this.itinerary));
                localStorage.setItem('trip_expenses_v2', JSON.stringify(this.expenses));
            },
            addDay() { this.days.push(this.days.length + 1); },
            openMap(location) { this.currentTab = 'map'; this.mapSearch = location; },
            updateMap() {}, // 觸發 computed 更新
            closeModal() { this.showAddModal = false; this.form = { id: null, time: '', location: '', note: '' }; this.isEditing = false; },
            editItem(item) { this.form = { ...item }; this.isEditing = true; this.showAddModal = true; },
            saveItem() {
                if (!this.form.time || !this.form.location) return alert('請輸入時間和地點');
                if (this.isEditing) {
                    const idx = this.itinerary.findIndex(i => i.id === this.form.id);
                    if (idx !== -1) this.itinerary[idx] = { ...this.form, day: this.activeDay };
                } else {
                    this.itinerary.push({ id: Date.now(), day: this.activeDay, ...this.form });
                }
                this.saveData(); this.closeModal();
            },
            deleteItem(id) { if(confirm('確定刪除此行程？')) { this.itinerary = this.itinerary.filter(i => i.id !== id); this.saveData(); } },
            addExpense() {
                if (!this.newExpense.payer || !this.newExpense.amount) return alert('請輸入付款人和金額');
                this.expenses.unshift({ ...this.newExpense });
                this.newExpense.amount = ''; this.newExpense.desc = ''; this.saveData();
            },
            deleteExpense(idx) { if(confirm('確定刪除這筆帳目？')) { this.expenses.splice(idx, 1); this.saveData(); } }
        }
    }).mount('#app');
</script>

</body>
</html>
